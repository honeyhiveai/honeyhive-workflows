name: hosting-stack
description: Kubernetes platform layer - EKS and supporting infrastructure
terraform_binary: terraform

# Stack-level configuration
stack_configuration:
  parallelism: 3
  retry_max_attempts: 2
  retry_sleep_interval_sec: 5

# Units in this stack
units:
  - path: units/hosting/cluster
    description: EKS Kubernetes cluster
    # Note: External dependency on substrate/vpc handled in unit
    
  - path: units/hosting/karpenter
    description: Kubernetes node autoscaling with Karpenter
    dependencies:
      - units/hosting/cluster
    skip: ${get_env("SKIP_KARPENTER", "false")}
    
  - path: units/hosting/addons
    description: EKS managed addons and controllers
    dependencies:
      - units/hosting/cluster
      - units/hosting/karpenter  # Ignored if karpenter is skipped
    
  - path: units/hosting/pod-identities
    description: Pod identity associations for workload authentication
    dependencies:
      - units/hosting/cluster
  
  - path: units/hosting/eso_secrets
    description: Application secrets stored in AWS Secrets Manager for sync via External Secrets Operator
    dependencies:
      - units/hosting/pod-identities  # ESO needs pod identity to access secrets
  
  - path: units/hosting/external_secrets
    description: Kubernetes ExternalSecret resources that pull secrets from AWS Secrets Manager
    dependencies:
      - units/hosting/pod-identities  # ESO needs pod identity to access secrets
      - units/hosting/addons  # ESO must be installed first
  
  - path: units/hosting/argocd_apps
    description: ArgoCD Applications for GitOps workload deployment
    dependencies:
      - units/hosting/addons  # ArgoCD must be installed first
      - units/hosting/external_secrets  # ExternalSecrets must exist before ArgoCD apps deploy
  
  - path: units/hosting/s3
    description: Observability S3 buckets for OpenTelemetry, Prometheus, and Grafana storage
    # No dependencies - can run in parallel with other hosting units