name: application-stack
description: Application layer resources - databases, storage, and services
terraform_binary: terraform

# Stack-level configuration
stack_configuration:
  parallelism: 2
  retry_max_attempts: 2
  retry_sleep_interval_sec: 5

# Units in this stack
units:
  - path: units/application/database
    description: Application databases (PostgreSQL RDS for control plane)
    # Note: External dependencies on substrate/vpc handled in unit
    skip: ${get_env("SKIP_DATABASE", "false")}
    
  - path: units/application/s3
    description: Application object storage buckets (control plane data store)
    
  - path: units/application/ecr
    description: ECR repositories for control plane and data plane services
    # Note: No external dependencies - creates container registries
    skip: ${get_env("SKIP_ECR", "false")}
    
  - path: units/application/secrets_configs
    description: Aggregates secrets and configs from modules/user config, stores in Secrets Manager, provides ConfigMap values
    dependencies:
      - units/application/database  # Optional - module handles missing outputs gracefully
      - units/application/ecr       # Optional - module handles missing outputs gracefully
    
  - path: units/application/iam
    description: Application IAM roles for control plane services (S3, Secrets Manager, ECR access)
    # Note: External dependencies on application/s3 and hosting/cluster handled in unit
    
  - path: units/application/argocd_apps
    description: ArgoCD Application for honeyhive-apps app-of-apps (deployed via Helm to avoid provider issues)
    # Note: External dependencies on hosting/cluster handled in unit
    dependencies:
      - units/application/secrets_configs  # ArgoCD needs IAM roles and ECR URLs
      - units/application/iam  # ArgoCD needs IAM roles for services
