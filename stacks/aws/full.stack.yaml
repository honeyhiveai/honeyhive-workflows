name: full-infrastructure
description: Complete infrastructure stack with all layers
terraform_binary: terraform

# Stack-level configuration
stack_configuration:
  parallelism: 3  # Reduced to ensure proper sequential execution across layers
  retry_max_attempts: 2
  retry_sleep_interval_sec: 5

# All units with proper dependency ordering
units:
  # Substrate layer - foundation
  - path: units/substrate/vpc
    description: Virtual Private Cloud
    
  - path: units/substrate/dns
    description: Private DNS zone
    dependencies:
      - units/substrate/vpc
    
  - path: units/substrate/twingate
    description: Zero-trust VPN
    dependencies:
      - units/substrate/vpc
    skip: ${get_env("SKIP_TWINGATE", "false")}
  
  # Hosting layer - platform
  - path: units/hosting/cluster
    description: EKS Kubernetes cluster
    dependencies:
      - units/substrate/vpc
    
  - path: units/hosting/karpenter
    description: Kubernetes autoscaler
    dependencies:
      - units/hosting/cluster
    skip: ${get_env("SKIP_KARPENTER", "false")}
    
  - path: units/hosting/addons
    description: EKS cluster addons
    dependencies:
      - units/hosting/cluster
      - units/hosting/karpenter  # If karpenter is skipped, this dependency is ignored
    
  - path: units/hosting/pod-identities
    description: Pod identity associations
    dependencies:
      - units/hosting/cluster
  
  - path: units/hosting/external_secrets
    description: Kubernetes ExternalSecret resources that pull secrets from AWS Secrets Manager
    dependencies:
      - units/hosting/pod-identities  # ESO needs pod identity to access secrets
      - units/hosting/addons  # ESO must be installed first
      - units/application/secrets_configs  # ExternalSecrets reads remote state from secrets_configs
  
  - path: units/hosting/argocd_apps
    description: ArgoCD Applications for core-utils, observability, and data-stores
    dependencies:
      - units/hosting/addons  # ArgoCD must be installed first
      - units/hosting/external_secrets  # ExternalSecrets must exist before ArgoCD apps deploy
  
  # Application layer - workloads
  - path: units/application/database
    description: Application database
    dependencies:
      - units/substrate/vpc
      - units/hosting/cluster
    
  - path: units/application/s3
    description: Application storage
    dependencies:
      - units/hosting/cluster
  
  - path: units/application/ecr
    description: ECR repositories for control plane and data plane services
    dependencies:
      - units/hosting/cluster
    skip: ${get_env("SKIP_ECR", "false")}
  
  - path: units/application/secrets_configs
    description: Aggregates secrets and configs from application modules
    dependencies:
      - units/application/database
      - units/application/ecr  # Optional - can be skipped
      - units/hosting/cluster
  
  - path: units/application/iam
    description: IAM roles and pod identity associations for services
    dependencies:
      - units/hosting/cluster
      - units/hosting/pod-identities
  
  - path: units/application/argocd_apps
    description: ArgoCD Application for honeyhive-apps app-of-apps (deployed via Helm to avoid provider issues)
    dependencies:
      - units/hosting/cluster  # Need cluster for Helm provider
      - units/hosting/addons  # ArgoCD must be installed first
      - units/application/secrets_configs  # ArgoCD needs IAM roles and ECR URLs
      - units/application/iam  # ArgoCD needs IAM roles for services
