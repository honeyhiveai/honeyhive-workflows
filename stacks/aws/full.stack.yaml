name: full-infrastructure
description: Complete infrastructure stack with all layers
terraform_binary: terraform

# Stack-level configuration
stack_configuration:
  parallelism: 5
  retry_max_attempts: 2
  retry_sleep_interval_sec: 5

# All units with proper dependency ordering
units:
  # Substrate layer - foundation
  - path: units/substrate/vpc-next
    description: Virtual Private Cloud
    
  - path: units/substrate/dns-next
    description: Private DNS zone
    dependencies:
      - units/substrate/vpc-next
    
  - path: units/substrate/twingate-next
    description: Zero-trust VPN
    dependencies:
      - units/substrate/vpc-next
    skip: ${get_env("SKIP_TWINGATE", "false")}
  
  # Hosting layer - platform
  - path: units/hosting/cluster-next
    description: EKS Kubernetes cluster
    dependencies:
      - units/substrate/vpc-next
    
  - path: units/hosting/karpenter-next
    description: Kubernetes autoscaler
    dependencies:
      - units/hosting/cluster-next
    skip: ${get_env("SKIP_KARPENTER", "false")}
    
  - path: units/hosting/addons-next
    description: EKS cluster addons
    dependencies:
      - units/hosting/cluster-next
      - units/hosting/karpenter-next  # If karpenter is skipped, this dependency is ignored
    
  - path: units/hosting/pod-identities-next
    description: Pod identity associations
    dependencies:
      - units/hosting/cluster-next
  
  - path: units/hosting/external_secrets
    description: Kubernetes ExternalSecret resources that pull secrets from AWS Secrets Manager
    dependencies:
      - units/hosting/pod-identities-next  # ESO needs pod identity to access secrets
      - units/hosting/addons-next  # ESO must be installed first
  
  - path: units/hosting/argocd_apps
    description: ArgoCD Applications for GitOps workload deployment
    dependencies:
      - units/hosting/addons-next  # ArgoCD must be installed first
      - units/hosting/external_secrets  # ExternalSecrets must exist before ArgoCD apps deploy
      - units/application/secrets_configs  # ArgoCD needs secrets/configs outputs for application deployment
  
  # Application layer - workloads
  - path: units/application/database-next
    description: Application database
    dependencies:
      - units/substrate/vpc-next
      - units/hosting/cluster-next
    
  - path: units/application/s3-next
    description: Application storage
    dependencies:
      - units/hosting/cluster-next
  
  - path: units/application/ecr
    description: ECR repositories for control plane and data plane services
    dependencies:
      - units/hosting/cluster-next
    skip: ${get_env("SKIP_ECR", "false")}
  
  - path: units/application/secrets_configs
    description: Aggregates secrets and configs from application modules
    dependencies:
      - units/application/database-next
      - units/application/ecr  # Optional - can be skipped
      - units/hosting/cluster-next
  
  - path: units/application/iam
    description: IAM roles and pod identity associations for services
    dependencies:
      - units/hosting/cluster-next
      - units/hosting/pod-identities-next
